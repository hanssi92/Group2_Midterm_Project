/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JPanel.java to edit this template
 */
package UserInterface.WorkAreas.AdminRole.ManageStudent;

import Business.Business;
import Business.UserAccounts.UserAccountDirectory;
import info5100.university.example.Department.Department;
import info5100.university.example.Persona.Person;
import info5100.university.example.Persona.PersonDirectory;
import info5100.university.example.Persona.StudentDirectory;
import info5100.university.example.Persona.StudentProfile;
import java.util.ArrayList;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.table.DefaultTableModel;

/**
 *
 * @author hdIV
 */
public class ManageStudent extends javax.swing.JPanel {
    
    JPanel CardSequencePanel;
    Business business;
    Department department;

    /**
     * Creates new form ManageStudent
     */
    public ManageStudent(Business b, JPanel clp) {
        this.business = b;
        this.CardSequencePanel = clp;
        this.department = b.getDepartment();
        initComponents();
        
        
        populateStudentTable();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        lblTitle = new javax.swing.JLabel();
        jScrollPane1 = new javax.swing.JScrollPane();
        tblStudents = new javax.swing.JTable();
        btnSearchStudentById = new javax.swing.JButton();
        btnSearchStudentByName = new javax.swing.JButton();
        btnSearchStudentByDept = new javax.swing.JButton();
        btnViewEditStudent = new javax.swing.JButton();
        btnDeleteStudent = new javax.swing.JButton();
        btnRefreshStudentList = new javax.swing.JButton();
        btnBack = new javax.swing.JButton();
        txtStudentSearch = new javax.swing.JTextField();

        setBackground(new java.awt.Color(0, 153, 153));

        lblTitle.setFont(new java.awt.Font("Helvetica Neue", 0, 24)); // NOI18N
        lblTitle.setText("Manage Student");

        tblStudents.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null}
            },
            new String [] {
                "ID", "Name", "Email", "Dept"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane1.setViewportView(tblStudents);
        if (tblStudents.getColumnModel().getColumnCount() > 0) {
            tblStudents.getColumnModel().getColumn(0).setResizable(false);
            tblStudents.getColumnModel().getColumn(1).setResizable(false);
            tblStudents.getColumnModel().getColumn(2).setResizable(false);
            tblStudents.getColumnModel().getColumn(3).setResizable(false);
        }

        btnSearchStudentById.setText("Search by ID");
        btnSearchStudentById.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnSearchStudentByIdActionPerformed(evt);
            }
        });

        btnSearchStudentByName.setText("Search by Name");
        btnSearchStudentByName.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnSearchStudentByNameActionPerformed(evt);
            }
        });

        btnSearchStudentByDept.setText("Search by Dept");
        btnSearchStudentByDept.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnSearchStudentByDeptActionPerformed(evt);
            }
        });

        btnViewEditStudent.setText("View / Edit Details");
        btnViewEditStudent.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnViewEditStudentActionPerformed(evt);
            }
        });

        btnDeleteStudent.setText("Delete Record");
        btnDeleteStudent.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnDeleteStudentActionPerformed(evt);
            }
        });

        btnRefreshStudentList.setText("Refresh Table");
        btnRefreshStudentList.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnRefreshStudentListActionPerformed(evt);
            }
        });

        btnBack.setText("<< Back");
        btnBack.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnBackActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(297, 297, 297)
                .addComponent(lblTitle)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(btnBack)
                .addGap(0, 0, Short.MAX_VALUE))
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(51, 51, 51)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(btnViewEditStudent, javax.swing.GroupLayout.PREFERRED_SIZE, 231, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addGap(18, 18, 18)
                                .addComponent(btnDeleteStudent, javax.swing.GroupLayout.PREFERRED_SIZE, 227, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addGap(36, 36, 36)
                                .addComponent(btnRefreshStudentList, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                                    .addComponent(jScrollPane1, javax.swing.GroupLayout.Alignment.LEADING)
                                    .addGroup(javax.swing.GroupLayout.Alignment.LEADING, layout.createSequentialGroup()
                                        .addComponent(btnSearchStudentById, javax.swing.GroupLayout.PREFERRED_SIZE, 225, javax.swing.GroupLayout.PREFERRED_SIZE)
                                        .addGap(18, 18, 18)
                                        .addComponent(btnSearchStudentByName, javax.swing.GroupLayout.PREFERRED_SIZE, 251, javax.swing.GroupLayout.PREFERRED_SIZE)
                                        .addGap(18, 18, 18)
                                        .addComponent(btnSearchStudentByDept, javax.swing.GroupLayout.DEFAULT_SIZE, 261, Short.MAX_VALUE)))
                                .addGap(18, 18, 18))))
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addContainerGap()
                        .addComponent(txtStudentSearch)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(15, 15, 15)
                .addComponent(lblTitle)
                .addGap(40, 40, 40)
                .addComponent(txtStudentSearch, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnSearchStudentById)
                    .addComponent(btnSearchStudentByName)
                    .addComponent(btnSearchStudentByDept))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 255, Short.MAX_VALUE)
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnViewEditStudent)
                    .addComponent(btnDeleteStudent)
                    .addComponent(btnRefreshStudentList))
                .addGap(64, 64, 64)
                .addComponent(btnBack)
                .addGap(55, 55, 55))
        );
    }// </editor-fold>//GEN-END:initComponents

    private void btnSearchStudentByIdActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnSearchStudentByIdActionPerformed
        // TODO add your handling code here:
        // --- "Search by ID" is implemented ---
        String searchId = txtStudentSearch.getText().trim();
        if (searchId.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Please enter a Student ID to search.", "Input Required", JOptionPane.WARNING_MESSAGE);
            return;
        }

        // Use the findStudent method from StudentDirectory
        StudentProfile foundStudent = department.getStudentDirectory().findStudent(searchId);

        ArrayList<StudentProfile> searchResults = new ArrayList<>();
        if (foundStudent != null) {
            searchResults.add(foundStudent); // Found, add to list
        }

        // Refresh the table using the new populate method
        populateStudentTable(searchResults);

        if (searchResults.isEmpty()) {
            JOptionPane.showMessageDialog(this, "No student found with ID: " + searchId, "Search Result", JOptionPane.INFORMATION_MESSAGE);
        }
    }//GEN-LAST:event_btnSearchStudentByIdActionPerformed

    private void btnSearchStudentByNameActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnSearchStudentByNameActionPerformed
        // TODO add your handling code here:
        String searchName = txtStudentSearch.getText().trim();
        if (searchName.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Please enter a name to search.", "Input Required", JOptionPane.WARNING_MESSAGE);
            return;
        }

        // Call the new method we just added to StudentDirectory.java
        ArrayList<StudentProfile> searchResults = department.getStudentDirectory().searchStudentByName(searchName);

        // Use the overloaded populate method to refresh the table
        populateStudentTable(searchResults);

        if (searchResults.isEmpty()) {
            JOptionPane.showMessageDialog(this, "No student found with name matching: " + searchName, "Search Result", JOptionPane.INFORMATION_MESSAGE);
        }
    }//GEN-LAST:event_btnSearchStudentByNameActionPerformed

    private void btnSearchStudentByDeptActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnSearchStudentByDeptActionPerformed
        // TODO add your handling code here:
        String searchDept = txtStudentSearch.getText().trim();
        if (searchDept.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Please enter a department name to search.", "Input Required", JOptionPane.WARNING_MESSAGE);
            return;
        }

        ArrayList<StudentProfile> searchResults = new ArrayList<>();

        // Check if the search term matches the current department's name (case-insensitive)
        if (department.getName().equalsIgnoreCase(searchDept)) {
            // If it matches, return all students from this department
            searchResults = department.getStudentDirectory().getStudentlist();
        }
        

        if (searchResults.isEmpty()) {
            JOptionPane.showMessageDialog(this, "No students found for department: " + searchDept, "Search Result", JOptionPane.INFORMATION_MESSAGE);
        }
    }//GEN-LAST:event_btnSearchStudentByDeptActionPerformed

    private void btnViewEditStudentActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnViewEditStudentActionPerformed
        // TODO add your handling code here:
        int selectedRow = tblStudents.getSelectedRow();

        if (selectedRow < 0) {
            JOptionPane.showMessageDialog(this, "Please select a student from the table to view/edit.", "No Student Selected", JOptionPane.WARNING_MESSAGE);
            return;
        }

        // 2. Get the Student ID from the table (column 0)
        String studentId = (String) tblStudents.getValueAt(selectedRow, 0);

        // 3. Find the StudentProfile object
        StudentProfile studentProfile = department.getStudentDirectory().findStudent(studentId);

        if (studentProfile == null) {
            JOptionPane.showMessageDialog(this, "Could not find the selected student. Please refresh.", "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        // 4. Create and navigate to the new panel
        ViewEditStudentJPanel viewEditPanel = new ViewEditStudentJPanel(business, CardSequencePanel, studentProfile);
        CardSequencePanel.add("ViewEditStudentJPanel", viewEditPanel);
        ((java.awt.CardLayout) CardSequencePanel.getLayout()).next(CardSequencePanel);
    }//GEN-LAST:event_btnViewEditStudentActionPerformed

    private void btnDeleteStudentActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnDeleteStudentActionPerformed
        // TODO add your handling code here:
        // 1. Get the selected row
        int selectedRow = tblStudents.getSelectedRow();

        if (selectedRow < 0) {
            JOptionPane.showMessageDialog(this, "Please select a student from the table to delete.", "No Student Selected", JOptionPane.WARNING_MESSAGE);
            return;
        }

        // 2. Get the Student ID from the table (column 0)
        String studentId = (String) tblStudents.getValueAt(selectedRow, 0);

        // 3. Show confirmation dialog
        int dialogResult = JOptionPane.showConfirmDialog(this,
            "Are you sure you want to delete student " + studentId + "?\nThis will also delete their associated Person and User Account records.",
            "Confirm Deletion",
            JOptionPane.YES_NO_OPTION,
            JOptionPane.WARNING_MESSAGE);

        if (dialogResult == JOptionPane.YES_OPTION) {
            // 4. Proceed with deletion
            try {
                // Get the directories
                StudentDirectory studentDirectory = department.getStudentDirectory();
                UserAccountDirectory userAccountDirectory = business.getUserAccountDirectory();
                PersonDirectory personDirectory = department.getPersonDirectory();

                // 5. Execute deletion in order (Profile -> Account -> Person)
                boolean profileRemoved = studentDirectory.removeStudentById(studentId);
                boolean accountRemoved = userAccountDirectory.removeUserAccountByPersonId(studentId);
                boolean personRemoved = personDirectory.removePersonById(studentId);

                // 6. Provide feedback
                if (profileRemoved && accountRemoved && personRemoved) {
                    JOptionPane.showMessageDialog(this, "Student " + studentId + " and all associated records have been deleted.", "Deletion Successful", JOptionPane.INFORMATION_MESSAGE);
                } else {
                    // This indicates a potential data integrity issue
                    String feedback = "Partial deletion. Please check data:\n";
                    if (!profileRemoved) feedback += "- Student Profile not found or not removed.\n";
                    if (!accountRemoved) feedback += "- User Account not found or not removed.\n";
                    if (!personRemoved) feedback += "- Person record not found or not removed.\n";
                    JOptionPane.showMessageDialog(this, feedback, "Deletion Warning", JOptionPane.WARNING_MESSAGE);
                }

                // 7. Refresh the table
                populateStudentTable();

            } catch (Exception e) {
                JOptionPane.showMessageDialog(this, "An error occurred during deletion: " + e.getMessage(), "Error", JOptionPane.ERROR_MESSAGE);
            }
        }
    }//GEN-LAST:event_btnDeleteStudentActionPerformed

    private void btnRefreshStudentListActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnRefreshStudentListActionPerformed
        // TODO add your handling code here:
        txtStudentSearch.setText("");
        populateStudentTable(); // Reload all students
    }//GEN-LAST:event_btnRefreshStudentListActionPerformed

    private void btnBackActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnBackActionPerformed
        // TODO add your handling code here:
        // Go back to the previous panel
        CardSequencePanel.remove(this);
        ((java.awt.CardLayout) CardSequencePanel.getLayout()).previous(CardSequencePanel);
    }//GEN-LAST:event_btnBackActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnBack;
    private javax.swing.JButton btnDeleteStudent;
    private javax.swing.JButton btnRefreshStudentList;
    private javax.swing.JButton btnSearchStudentByDept;
    private javax.swing.JButton btnSearchStudentById;
    private javax.swing.JButton btnSearchStudentByName;
    private javax.swing.JButton btnViewEditStudent;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JLabel lblTitle;
    private javax.swing.JTable tblStudents;
    private javax.swing.JTextField txtStudentSearch;
    // End of variables declaration//GEN-END:variables

            
    public void populateStudentTable(ArrayList<StudentProfile> studentList) {
        DefaultTableModel model = (DefaultTableModel) tblStudents.getModel(); // Assuming your student table is named tblStudents
        model.setRowCount(0);

        if (studentList == null) {
            return; // No students in the list
        }

        for (StudentProfile sp : studentList) {
            Person person = sp.getPerson(); // StudentProfile should have an associated Person
            if (person != null) {
                Object[] row = new Object[4];
                row[0] = person.getPersonId(); 
                row[1] = person.getFirstName();
                row[2] = person.getEmail();
                
                // --- MODIFICATION: Get department from profile, not panel ---
                // (Assuming StudentProfile was also updated with getDepartment())
                if (sp.getDepartment() != null) {
                    row[3] = sp.getDepartment().getName();
                } else {
                    row[3] = "Unassigned"; // More accurate
                }
                
                model.addRow(row);
            }
        }
    }
    public void populateStudentTable() {
        StudentDirectory studentDirectory = department.getStudentDirectory();
        if (studentDirectory != null) {
            populateStudentTable(studentDirectory.getStudentlist());
        }
    }
}
